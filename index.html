<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- iOS Web-App Einstellungen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Trouble Brewing">

  <!-- Homescreen Icon (1024x1024, quadratisch, ohne Transparenz) -->
  <link rel="apple-touch-icon" href="icon.png">

 <link rel="apple-touch-icon" href="icon.png">
 
  <title>Trouble Brewing Ablauf</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 10px;
      background: #f5f5f5;
      font-size: 16px;
    }
    h1 { 
      text-align: center; 
      font-size: 1.6em;
      margin-bottom: 15px;
    }
    button {
      font-size: 18px;
      padding: 12px 18px;
      margin: 5px;
      border-radius: 12px;
      border: none;
      background: #1976d2;
      color: white;
      cursor: pointer;
      min-height: 44px; /* Fingerfreundlich */
    }
    button:hover { background: #0d47a1; }
    select, input, textarea {
      font-size: 18px;
      margin: 6px 0;
      padding: 10px;
      width: 100%;
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      min-height: 44px; /* Fingerfreundlich */
    }
    textarea {
      resize: vertical;
    }
    .runde-box, .notiz-box {
      margin: 12px 0;
      padding: 12px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .historie {
      margin-top: 20px;
      padding: 12px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .aktion { 
      margin-bottom: 12px; 
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .aktion select, .aktion input {
      flex: 1 1 45%;
      min-width: 140px;
    }
    .aktion button {
      flex: 0 0 auto;
	  


    }
    /* Mobile Optimierungen */
    @media (max-width: 600px) {
      body {
        margin: 5px;
        font-size: 15px;
      }
      button {
        font-size: 16px;
        padding: 10px 14px;
      }
      .runde-box, .historie {
        padding: 10px;
      }
      .aktion {
        flex-direction: column;
      }
      .aktion select, .aktion input {
        width: 100%;
        flex: unset;
      }
    }
  </style>
</head>
<body>

<h1>Trouble Brewing Dokumentation</h1>

<div id="charakter-auswahl" class="runde-box">
  <h2>Charaktere auswählen</h2>
  <div id="charaktere-liste"></div>
  <button onclick="speichereCharaktere()">Auswahl speichern</button>
</div>

<div id="spieler-zuweisung" class="runde-box" style="display:none;">
  <h2>Spielernamen zuweisen</h2>
  <div id="zuweisungen"></div>
  <button onclick="speichereSpieler()">Spielernamen speichern</button>
</div>

<div id="runde-bereich" style="display:none;">
  <div class="runde-box">
    <h2 id="rundenanzeige">Runde 1</h2>
    <button onclick="neueAktion()">Aktion hinzufügen</button>
    <div id="aktionen"></div>
    <h3>Notizen</h3>
    <textarea id="notizen" rows="3" placeholder="Notizen zur Runde..."></textarea>
    <br>
    <button onclick="rundeSpeichern()">Runde speichern</button>
  </div>
</div>

<div class="historie">
  <h2>Historie</h2>
  <div id="historie-liste"></div>
  <button onclick="rundeRueckgaengig()">Letzte Runde rückgängig</button>
  <button onclick="historieLoeschen()">Historie löschen</button>
  <button onclick="charaktereZuruecksetzen()">Charaktere & Spielernamen zurücksetzen</button>
</div>

<script>
const alleCharaktere = [
  "Waschweib","Bibliothekar","Detektiv","Koch","Empath","Wahrsagerin","Soldat",
  "Totengräber","Mönch","Rabenhüter","Jungfrau","Dämonenjäger","Bürgermeister",
  "Butler","Heilige","Einsiedler","Trunkenbold","Baron","Scharlachrote Frau",
  "Spion", "Giftmischer","Imp", "Falsche Fährte"
];

let ausgewaehlteCharaktere = JSON.parse(localStorage.getItem("charaktere")) || [];
let spieler = JSON.parse(localStorage.getItem("spieler")) || {};
let historie = JSON.parse(localStorage.getItem("historie")) || [];
let runde = historie.length + 1;

// --- Zusatzfeld als Button ---
function erstelleErgaenzungsfeld() {
  const container = document.createElement("span");
  const btn = document.createElement("button");
  btn.type = "button";
  btn.textContent = "+ Ergänzung";
  btn.style.marginLeft = "5px";
  btn.onclick = () => {
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Ergänzung";
    input.style.marginLeft = "5px";
    container.replaceChild(input, btn);
  };
  container.appendChild(btn);
  return container;
}

// Charakter-Auswahl
function ladeCharaktere() {
            const liste = document.getElementById("charaktere-liste");
            liste.innerHTML = "";
            
            // Container für die Checkboxen mit Flexbox
            liste.style.display = "flex";
            liste.style.flexWrap = "wrap";
            liste.style.gap = "10px";
            liste.style.marginBottom = "15px";
            
            alleCharaktere.forEach(ch => {
                // Container für jede Checkbox-Label-Kombination
                const container = document.createElement("div");
                container.style.display = "flex";
                container.style.alignItems = "center";
                container.style.marginRight = "15px";
                
                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.value = ch;
                cb.checked = ausgewaehlteCharaktere.includes(ch);
                cb.id = "cb-" + ch; // ID für Label-Referenz
                cb.style.marginRight = "5px";
                
                const lbl = document.createElement("label");
                lbl.textContent = ch;
                lbl.htmlFor = "cb-" + ch; // Verknüpfung mit Checkbox
                lbl.style.whiteSpace = "nowrap"; // Verhindert Zeilenumbruch
                
                container.appendChild(cb);
                container.appendChild(lbl);
                liste.appendChild(container);
            });
        }


function speichereCharaktere() {
  ausgewaehlteCharaktere = Array.from(document.querySelectorAll("#charaktere-liste input:checked")).map(cb => cb.value);
  localStorage.setItem("charaktere", JSON.stringify(ausgewaehlteCharaktere));
  zeigeSpielerZuweisung();
}
function zeigeSpielerZuweisung() {
  document.getElementById("spieler-zuweisung").style.display = "block";
  const container = document.getElementById("zuweisungen");
  container.innerHTML = "";
  ausgewaehlteCharaktere.forEach(ch => {
    const row = document.createElement("div");
    row.className = "zuweisung-row"; // Flex-Container

    const label = document.createElement("label");
    label.textContent = ch + ":";

    const input = document.createElement("input");
    input.type = "text";
    input.value = spieler[ch] || "";
    input.dataset.char = ch;

    row.appendChild(label);
    row.appendChild(input);

    container.appendChild(row);
  });
}

function speichereSpieler() {
  document.querySelectorAll("#zuweisungen input").forEach(inp => {
    spieler[inp.dataset.char] = inp.value;
  });
  localStorage.setItem("spieler", JSON.stringify(spieler));
  document.getElementById("runde-bereich").style.display = "block";
  aktualisiereHistorie();

  // --- Standardaktionen für Runde 1 ---
  if (runde === 1) {
    if (ausgewaehlteCharaktere.includes("Trunkenbold")) neueAktion("Trunkenbold");
	if (ausgewaehlteCharaktere.includes("Falsche Fährte")) neueAktion("Falsche Fährte");
    if (ausgewaehlteCharaktere.includes("Giftmischer")) neueAktion("Giftmischer", "vergiftet");
    if (ausgewaehlteCharaktere.includes("Waschweib")) neueAktion("Waschweib", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Bibliothekar")) neueAktion("Bibliothekar", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Detektiv")) neueAktion("Detektiv", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Koch")) neueAktion("Koch", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Empath")) neueAktion("Empath", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Wahrsagerin")) neueAktion("Wahrsagerin", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Butler")) neueAktion("Butler", "bekommt Info über");
  }
}


function neueAktion(vorwahlChar = null, vorwahlAktion = null) {
  const div = document.createElement("div");
  div.className = "aktion";

  // Erstes Select (Charakter 1)
  const select1 = document.createElement("select");
  const optLeer1 = document.createElement("option");
  optLeer1.textContent = "leer";
  select1.appendChild(optLeer1);
  ausgewaehlteCharaktere.forEach(c => {
    const sp = spieler[c] ? ` (${spieler[c]})` : "";
    const opt = document.createElement("option");
    opt.textContent = c + sp;
    select1.appendChild(opt);
  });

  // Zweites Select (Aktion)
  const select2 = document.createElement("select");
  ["nominiert","tötet","vergiftet","bekommt Info über","beschützt","erschießt","wird zu","wird Butler von","erscheint als","stirbt"].forEach(a => {
    const opt = document.createElement("option");
    opt.textContent = a;
    select2.appendChild(opt);
  });

  // Automatische Vorauswahl für Waschweib
  select1.addEventListener("change", () => {
    if (select1.value.startsWith("Waschweib")) {
      select2.value = "bekommt Info über";
    }
  });

  // Drittes Select (Charakter 2)
  const select3 = document.createElement("select");
  const optLeer3 = document.createElement("option");
  optLeer3.textContent = "leer";
  select3.appendChild(optLeer3);
  ausgewaehlteCharaktere.forEach(c => {
    const sp = spieler[c] ? ` (${spieler[c]})` : "";
    const opt = document.createElement("option");
    opt.textContent = c + sp;
    select3.appendChild(opt);
  });

  // Viertes Select (optional weiterer Charakter)
  const select4 = document.createElement("select");
  const optLeer4 = document.createElement("option");
  optLeer4.textContent = "leer";
  select4.appendChild(optLeer4);
  ausgewaehlteCharaktere.forEach(c => {
    const sp = spieler[c] ? ` (${spieler[c]})` : "";
    const opt = document.createElement("option");
    opt.textContent = c + sp;
    select4.appendChild(opt);
  });

  // Vorbelegung wenn Parameter übergeben
  if (vorwahlChar) {
    for (let i = 0; i < select1.options.length; i++) {
      if (select1.options[i].text.startsWith(vorwahlChar)) {
        select1.selectedIndex = i;
        break;
      }
    }
  }
  if (vorwahlAktion) {
    select2.value = vorwahlAktion;
  }

  // Zusammenbauen
  div.appendChild(select1);
  div.appendChild(select2);
  div.appendChild(select3);
  div.appendChild(erstelleErgaenzungsfeld());
  div.appendChild(select4);
  div.appendChild(erstelleErgaenzungsfeld());

  document.getElementById("aktionen").appendChild(div);
}

function rundeSpeichern() {
  const aktionen = Array.from(document.querySelectorAll("#aktionen .aktion")).map(a => {
    const selects = a.querySelectorAll("select");
    const inputs = a.querySelectorAll("input");
    const [ch1, act, ch2, ch3] = selects;
    const erg1 = inputs[0] ? inputs[0].value : "";
    const erg2 = inputs[1] ? inputs[1].value : "";
    return `${ch1.value} ${act.value} ${ch2.value} ${erg1} ${ch3.value} ${erg2}`;
  });
  const notizen = document.getElementById("notizen").value;
  historie.push({runde, aktionen, notizen});
  localStorage.setItem("historie", JSON.stringify(historie));
  runde++;
  document.getElementById("rundenanzeige").textContent = "Runde " + runde;
  document.getElementById("aktionen").innerHTML = "";
  document.getElementById("notizen").value = "";
  aktualisiereHistorie();

  // --- Standardaktionen ab Runde 2 ---
  if (runde >= 2) {
    if (ausgewaehlteCharaktere.includes("Giftmischer")) neueAktion("Giftmischer", "vergiftet");
    if (ausgewaehlteCharaktere.includes("Mönch")) neueAktion("Mönch", "beschützt");
	if (ausgewaehlteCharaktere.includes("Imp")) neueAktion("Imp", "tötet");
	if (ausgewaehlteCharaktere.includes("Rabenhüter")) neueAktion("Mönch", "beschützt");
	if (ausgewaehlteCharaktere.includes("Empath")) neueAktion("Empath", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Wahrsagerin")) neueAktion("Wahrsagerin", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Totengräber")) neueAktion("Totengräber", "bekommt Info über");
	if (ausgewaehlteCharaktere.includes("Butler")) neueAktion("Butler", "wird Butler von");
  }
}

// Historie verwalten
function aktualisiereHistorie() {
  const liste = document.getElementById("historie-liste");
  liste.innerHTML = "";
  historie.forEach(h => {
    const div = document.createElement("div");
    div.className = "runde-box";
    div.innerHTML = `<h3>Runde ${h.runde}</h3>
      <ul>${h.aktionen.map(a => `<li>${a}</li>`).join("")}</ul>
      <p><strong>Notizen:</strong> ${h.notizen}</p>`;
    liste.appendChild(div);
  });
}

function neueAktion(vorwahlChar = null, vorwahlAktion = null) {
  const div = document.createElement("div");
  div.className = "aktion";

  // Erstes Select (Charakter 1)
  const select1 = document.createElement("select");
  const optLeer1 = document.createElement("option");
  optLeer1.textContent = "leer";
  select1.appendChild(optLeer1);
  ausgewaehlteCharaktere.forEach(c => {
    const sp = spieler[c] ? ` (${spieler[c]})` : "";
    const opt = document.createElement("option");
    opt.textContent = c + sp;
    select1.appendChild(opt);
  });

  // Zweites Select (Aktion)
  const select2 = document.createElement("select");
  ["nominiert","tötet","vergiftet","bekommt Info über","beschützt","erschießt",
   "wird zu","wird Butler von","erscheint als","stirbt"].forEach(a => {
    const opt = document.createElement("option");
    opt.textContent = a;
    select2.appendChild(opt);
  });

  // Automatische Vorauswahl für Waschweib
  select1.addEventListener("change", () => {
    if (select1.value.startsWith("Waschweib")) {
      select2.value = "bekommt Info über";
    }
  });

  // Drittes Select (Charakter 2)
  const select3 = document.createElement("select");
  const optLeer3 = document.createElement("option");
  optLeer3.textContent = "leer";
  select3.appendChild(optLeer3);
  ausgewaehlteCharaktere.forEach(c => {
    const sp = spieler[c] ? ` (${spieler[c]})` : "";
    const opt = document.createElement("option");
    opt.textContent = c + sp;
    select3.appendChild(opt);
  });

  // Viertes Select (weiterer Charakter)
  const select4 = document.createElement("select");
  const optLeer4 = document.createElement("option");
  optLeer4.textContent = "leer";
  select4.appendChild(optLeer4);
  ausgewaehlteCharaktere.forEach(c => {
    const sp = spieler[c] ? ` (${spieler[c]})` : "";
    const opt = document.createElement("option");
    opt.textContent = c + sp;
    select4.appendChild(opt);
  });

  // Vorbelegung
  if (vorwahlChar) {
    for (let i = 0; i < select1.options.length; i++) {
      if (select1.options[i].text.startsWith(vorwahlChar)) {
        select1.selectedIndex = i;
        break;
      }
    }
  }
  if (vorwahlAktion) {
    select2.value = vorwahlAktion;
  }

  // Button zum Löschen dieser Aktion
  const delBtn = document.createElement("button");
  delBtn.type = "button";
  delBtn.textContent = "❌";
  delBtn.style.marginLeft = "8px";
  delBtn.onclick = () => div.remove();

  // Zusammenbauen
  div.appendChild(select1);
  div.appendChild(select2);
  div.appendChild(select3);
  div.appendChild(erstelleErgaenzungsfeld());
  div.appendChild(select4);
  div.appendChild(erstelleErgaenzungsfeld());
  div.appendChild(delBtn);

  document.getElementById("aktionen").appendChild(div);
}

function rundeRueckgaengig() {
  if (historie.length > 0 && confirm("Letzte Runde wirklich löschen?")) {
    historie.pop();
    localStorage.setItem("historie", JSON.stringify(historie));
    runde = historie.length + 1;
    document.getElementById("rundenanzeige").textContent = "Runde " + runde;
    aktualisiereHistorie();
  }
}
function historieLoeschen() {
  if (confirm("Gesamte Historie wirklich löschen?")) {
    historie = [];
    localStorage.removeItem("historie");
    runde = 1;
    document.getElementById("rundenanzeige").textContent = "Runde " + runde;
    aktualisiereHistorie();
  }
}
function charaktereZuruecksetzen() {
  if (confirm("Charaktere und Spielernamen wirklich zurücksetzen?")) {
    localStorage.removeItem("charaktere");
    localStorage.removeItem("spieler");
    ausgewaehlteCharaktere = [];
    spieler = {};
    location.reload();
  }
}

// Initial laden
ladeCharaktere();
if (ausgewaehlteCharaktere.length > 0) zeigeSpielerZuweisung();
if (Object.keys(spieler).length > 0) document.getElementById("runde-bereich").style.display = "block";
aktualisiereHistorie();
</script>



</body>
</html>
